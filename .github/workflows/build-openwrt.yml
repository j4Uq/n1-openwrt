name: Reusable OpenWrt Build

on:
  workflow_call:
    inputs:
      device:
        description: 'Device name (e.g., N1, ACRH17)'
        required: true
        type: string
      config_dir:
        description: 'Path to device-specific config directory (e.g., armsr/armv8/N1)'
        required: true
        type: string
      diy_script:
        description: 'Filename of diy.sh script (e.g., diy.sh)'
        required: true
        type: string
      release_tag_prefix:
        description: 'Prefix for release tag'
        required: true
        type: string
      default_ip:
        description: 'Default IP address for the device'
        required: true
        type: string
      ssh:
        description: 'Enable SSH debug'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: ${{ vars.REPO_URL || 'https://github.com/immortalwrt/immortalwrt' }}
  REPO_BRANCH: ${{ vars.REPO_BRANCH || 'openwrt-25.12' }}
  TZ: ${{ vars.TZ || 'Asia/Shanghai' }}

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Initialize build environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh | sudo bash > /dev/null
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: Clone source code
        working-directory: /workdir
        run: |
          git clone $REPO_URL -b $REPO_BRANCH --single-branch --depth=1 openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          echo "FILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: Update & install feeds
        run: |
          chmod +x ${{ inputs.config_dir }}/${{ inputs.diy_script }}
          cd openwrt
          ./scripts/feeds update -a
          $GITHUB_WORKSPACE/${{ inputs.config_dir }}/${{ inputs.diy_script }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Load device-specific config
        run: |
          rm -rf openwrt/files openwrt/.config
          if [ -d "${{ inputs.config_dir }}/files" ]; then
            cp -r ${{ inputs.config_dir }}/files openwrt/
          else
            echo "Warning: ${{ inputs.config_dir }}/files does not exist, skipping."
          fi
          if [ -f "${{ inputs.config_dir }}/.config" ]; then
            cp ${{ inputs.config_dir }}/.config openwrt/
          else
            echo "Warning: ${{ inputs.config_dir }}/.config does not exist, skipping."
          fi

      - name: SSH debug session
        uses: P3TERX/ssh2actions@main
        if: inputs.ssh

      - name: Download packages
        working-directory: ./openwrt
        run: |
          make defconfig
          make download -j$(( $(nproc) * 2 ))
          find dl -size -1k -exec rm -f {} \;

      - name: Compile firmware
        run: |
          chmod -R 755 openwrt
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(( $(nproc) + 1 )) || make -j1 V=s

      # N1 specific packaging (using flippy action)
      - name: Package N1 firmware
        if: inputs.device == 'N1'
        uses: ophub/flippy-openwrt-actions@main
        env:
          OPENWRT_ARMVIRT: openwrt/bin/targets/armsr/armv8/*rootfs.tar.gz
          KERNEL_REPO_URL: ophub/kernel
          KERNEL_VERSION_NAME: 6.1.y_6.18.y
          PACKAGE_SOC: diy
          SCRIPT_DIY_PATH: ${{ inputs.config_dir }}/mk_s905d_n1.sh
          GZIP_IMGS: .xz
          WHOAMI: ${{ github.actor }}
          SW_FLOWOFFLOAD: 0
          SFE_FLOW: 0

      # Generic device (e.g., ACRH17) file organization
      - name: Find firmware directory and organize files
        id: firmware_dir
        if: inputs.device != 'N1'
        run: |
          cd openwrt/bin/targets
          # Find the first target directory
          target_dir=$(ls -d */ | head -1)
          if [ -z "$target_dir" ]; then
            echo "No target directory found in bin/targets/"
            exit 1
          fi
          cd "$target_dir"
          # Find the first subtarget directory
          subtarget_dir=$(ls -d */ | head -1)
          if [ -z "$subtarget_dir" ]; then
            echo "No subtarget directory found in $target_dir"
            exit 1
          fi
          cd "$subtarget_dir"
          firmware_path=$(pwd)
          echo "Firmware directory: $firmware_path"
          # Store path for later steps
          echo "firmware_path=$firmware_path" >> $GITHUB_OUTPUT
          # Remove packages directory
          rm -rf packages
          # Remove all files except factory and sysupgrade images
          find . -mindepth 1 ! \( -name '*factory*' -o -name '*sysupgrade*' \) -exec rm -rf {} +

      # Determine artifact path for upload
      - name: Set artifact path
        id: artifacts
        run: |
          if [[ "${{ inputs.device }}" == "N1" ]]; then
            # For N1, the flippy action outputs to PACKAGED_OUTPUTPATH
            echo "path=${{ env.PACKAGED_OUTPUTPATH }}" >> $GITHUB_OUTPUT
          else
            # For other devices, use the path from the firmware directory step
            echo "path=${{ steps.firmware_dir.outputs.firmware_path }}" >> $GITHUB_OUTPUT
          fi

      - name: List firmware files
        run: ls -la "${{ steps.artifacts.outputs.path }}"

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag_prefix }}_${{ env.FILE_DATE }}
          files: ${{ steps.artifacts.outputs.path }}/*
          fail_on_unmatched_files: true
          body: |
            首次使用建议全新刷写
            * 基本信息
            IP: ${{ inputs.default_ip }}
            账户: root
            密码: password

      - name: Delete old releases for this device
        if: always()
        run: |
          prefix="${{ inputs.release_tag_prefix }}_"
          gh release list --limit 100 --json tagName,createdAt --jq '.[] | select(.tagName | startswith(env.prefix)) | .tagName' | sort -r | tail -n +11 | while read tag; do
            echo "Deleting release $tag"
            gh release delete "$tag" --yes
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          prefix: ${{ inputs.release_tag_prefix }}_

      - name: Delete old workflow runs and artifacts
        if: always()
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          retain_days: 14
          keep_minimum_runs: 4

name: Check Upstream

on:
  schedule:
    - cron: "0 20 * * 4"   # 每周四 UTC 20:00
  workflow_dispatch:        # 允许手动触发检查

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-25.12

jobs:
  check:
    runs-on: ubuntu-24.04
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for upstream updates
        id: check
        run: |
          API_URL="https://api.github.com/repos/immortalwrt/immortalwrt/commits?sha=${{ env.REPO_BRANCH }}&per_page=1"
          response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$API_URL")

          if [ $? -ne 0 ] || [ -z "$response" ]; then
            echo "上游仓库API调用失败，触发构建。"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          commit_date=$(echo "$response" | jq -r '.[0].commit.committer.date')
          if [ -z "$commit_date" ] || [ "$commit_date" == "null" ]; then
            echo "无法提取提交日期，触发构建。"
            echo "should_build=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          commit_ts=$(date -d "$commit_date" +%s)
          now_ts=$(date -u +%s)
          days_diff=$(( (now_ts - commit_ts) / 86400 ))
          if (( days_diff < 7 )); then
            echo "上游最近更新在 ${days_diff} 天前，触发构建。"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "上游超过7天未更新，跳过构建。"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Trigger device builds
        if: steps.check.outputs.should_build == 'true'
        run: |
          set -e
          echo "寻找设备工作流文件：.github/workflows/device_*.yml"
          for workflow in .github/workflows/device_*.yml; do
            if [ -f "$workflow" ]; then
              workflow_name=$(basename "$workflow")
              echo "触发工作流：$workflow_name"
              gh workflow run "$workflow_name" -f ssh=false --ref "${{ github.ref_name }}"
            else
              echo "没有找到匹配的 device_*.yml 文件"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}